{{- $pullSecretName := printf "pullsecret-%s" $.Values.clusterName }}
{{- $clusterName := $.Values.clusterName }}
{{- $bmcCredentialSecret := printf "bmc-credentials-" $clusterName }}
{{- $imageSet := printf "%s-%s" "openshift-image-set" $.Values.openshiftVersion }}
{{- $controlPlaneCount := $.Values.controlPlaneAgents | default 3 }}
{{- $workerCount := $.Values.workerAgents | default (sub ($.Values.hosts | len)  $controlPlaneCount) }}

---
apiVersion: extensions.hive.openshift.io/v1beta1
kind: AgentClusterInstall
metadata:
  name: {{ $clusterName }}
  namespace: {{ $clusterName }}
spec:
  clusterDeploymentRef:
    name: {{ $clusterName }}
  imageSetRef:
    name: {{ $imageSet }}
  holdInstallation: false
  {{- if not ($.Values.sno | default false) }}
  apiVip: {{ $.Values.apiVip }}
  ingressVip: {{ $.Values.ingressVip }}
  mastersSchedulable: false
  provisionRequirements:
    controlPlaneAgents: {{ $controlPlaneCount }}
    workerAgents: {{ $workerCount }}
  networking:
    networkType: OVNKubernetes
    clusterNetwork:
    - cidr: {{ $.Values.networking.clusterNetwork.cidr }}
      hostPrefix: {{ $.Values.networking.clusterNetwork.hostPrefix }}
    machineNetwork:
    - cidr: {{ $.Values.networking.machineNetwork.cidr }}
    serviceNetwork:
    {{- range $_, $network := $.Values.serviceNetwork }}
    - {{ $network }}
    {{ end }}
  {{- else }}
  mastersScheduable: true
  networking:
    networkType: OVNKubernetes
    clusterNetwork:
    - cidr: {{ $.Values.networking.clusterNetwork.cidr }}
      hostPrefix: {{ $.Values.networking.clusterNetwork.hostPrefix }}
    machineNetwork:
    - cidr: {{ $.Values.networking.machineNetwork.cidr }}
    serviceNetwork:
    {{- range $_, $network := $.Values.serviceNetwork }}
    - {{ $network }}
    {{ end }}
  provisionRequirements:
    controlPlaneAgents: 1
  {{- end }}
  sshPublicKey: {{ $.Values.sshPublicKey | default "" }}
